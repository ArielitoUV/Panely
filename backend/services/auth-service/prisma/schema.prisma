generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int      @id @default(autoincrement())
  email         String   @unique
  password      String
  nombre        String
  apellido      String
  role          String   @default("USER") // "USER" o "ADMIN"
  telefono      String?
  nombreEmpresa String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // ... (resto de relaciones igual: insumos, refreshTokens, cajaDiaria, etc.)
  insumos       Insumo[]
  refreshTokens RefreshToken[]
  cajaDiaria    CajaDiaria[]
  recetas       Receta[]
  pedidos       Pedido[]
  ingresos      Ingreso[]
  egresos       Egreso[]
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    Int
  token     String   @unique
  expiresAt DateTime

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Insumo {
  id             Int      @id @default(autoincrement())
  nombre         String
  presentacion   String
  cantidadCompra Float
  unidadMedida   String
  valorCompra    Int
  
  // Campos calculados
  stockGramos    Float    @default(0)
  costoPorGramo  Float    @default(0)
  costoPorUnidad Float?   // Opcional por compatibilidad

  userId         Int
  createdAt      DateTime @default(now())

  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  enRecetas      IngredienteReceta[]

  @@index([userId])
}

model Receta {
  id            Int      @id @default(autoincrement())
  nombre        String
  cantidadBase  Int
  userId        Int
  
  ingredientes  IngredienteReceta[]
  pedidos       Pedido[]
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  @@index([userId])
}

model IngredienteReceta {
  id             Int    @id @default(autoincrement())
  recetaId       Int
  insumoId       Int
  cantidadGramos Float

  receta         Receta @relation(fields: [recetaId], references: [id], onDelete: Cascade)
  insumo         Insumo @relation(fields: [insumoId], references: [id], onDelete: Cascade)

  @@index([recetaId])
  @@index([insumoId])
}

model Pedido {
  id            Int      @id @default(autoincrement())
  nombreCliente String
  cantidadPanes Int
  montoTotal    Int
  fecha         DateTime @default(now())
  
  recetaId      Int
  userId        Int
  resumen       String?  @db.Text 

  receta        Receta   @relation(fields: [recetaId], references: [id])
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recetaId])
}

// --- CAJA DIARIA MEJORADA ---
model CajaDiaria {
  id            Int      @id @default(autoincrement())
  fecha         DateTime @unique
  montoInicial  Int
  
  // Detalle de Ingresos (Ventas)
  efectivo      Int      @default(0)
  tarjeta       Int      @default(0)
  transferencia Int      @default(0)
  
  // Resultado Final (Se calculan al cerrar)
  totalVentas   Int      @default(0) // Suma de ingresos
  totalEgresos  Int      @default(0) // Suma de egresos
  gananciaNeta  Int      @default(0) // Ventas - Egresos
  
  totalFinal    Int // Dinero en caja (Efectivo + Inicial - Gastos en Efectivo)
  
  estado        String   @default("ABIERTA")
  notas         String?
  userId        Int
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  @@index([userId])
  @@index([fecha])
}

model Ingreso {
  id          Int      @id @default(autoincrement())
  monto       Int
  descripcion String
  metodoPago  String   // EFECTIVO, TARJETA, TRANSFERENCIA
  fecha       DateTime @default(now())
  
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// NUEVO MODELO: Catálogo de tipos de insumos
model TipoInsumo {
  id        Int      @id @default(autoincrement())
  nombre    String   @unique // Ej: "Harina", "Sal"
}

// NUEVO MODELO: Catálogo de presentaciones
model TipoPresentacion {
  id        Int      @id @default(autoincrement())
  nombre    String   @unique // Ej: "Saco", "Caja"
}

model Egreso {
  id          Int      @id @default(autoincrement())
  monto       Int
  descripcion String
  categoria   String   @default("COMPRA_INSUMO") // Para filtrar después
  fecha       DateTime @default(now())
  userId      Int
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  @@index([userId])
}